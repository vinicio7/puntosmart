if (self.CavalryLogger) { CavalryLogger.start_js(["nLuVy"]); }

__d('FantaReducersGetMessages',['AsyncRequest','FantaGetMessageActions','FantaTabActions','FantaTypeJoinableThread','immutable','ImmutableObject','MercuryIDs','MercuryLogMessageType','MercuryMessageStore','MercuryThreadActions','MercuryThreads','UserActivity','XMNCommercePageNullStateCTAController','getPageIDFromThreadID','setImmediate'],(function a(b,c,d,e,f,g){'use strict';var h=c('MercuryThreadActions').get(),i=c('MercuryThreads').get(),j=c('FantaTabActions').Types,k=c('FantaGetMessageActions').Types,l={},m={};function n(ia,ja){switch(ja.type){case j.OPEN_TAB:case k.CLEAR_PARTICIPANTS:ia=y(ia,ja.tabID);break;}return ia;}function o(ia,ja){switch(ja.type){case j.OPEN_TAB_WITH_INTERSTITIAL_DATA:ia=z(ia,ja.interstitialData);break;}return ia;}function p(ia,ja){switch(ja.type){case j.REPLACE_TAB:ia=y(ia,ja.newTabID);break;}return ia;}function q(ia,ja){switch(ja.type){case k.CLEAR_PREVIEW:var ka=ja.tabID,la=ja.tokens,ma=ia.mercury.tabContents.get(ka);if(!ma)return ia;var na=la.map(function(oa){var pa=oa.info.uid;if(c('MercuryIDs').isValid(pa))return pa;return c('MercuryIDs').getParticipantIDFromUserID(pa);});ma.messageStore&&ma.messageStore.destroy();ia=ia.mergeIn(['mercury','tabContents',ka],{messages:c('immutable').List(),hasFetchedAll:false,messageStore:null,threadPreviewID:null,threadPreviewRecipients:c('immutable').List(na)});i.getThreadMeta(ka,function(oa){c('setImmediate')(function(){return c('FantaGetMessageActions').onGetThreadPreviewResponse(ka,oa);});});break;}return ia;}function r(ia,ja){switch(ja.type){case k.ADD_PARTICIPANTS:ia=u(ia,ja.tabID,ja.previewTabID);break;}return ia;}function s(ia,ja){switch(ja.type){case j.LOAD_FROM_DATA:var ka=ia.tabGroup,la=ja.tabData,ma=la.interstitialData;if(ka.updatedTime>=la.updatedTime||la.updatedTime===undefined){for(var na=ia.tabGroup.tabs.keys(),oa=Array.isArray(na),pa=0,na=oa?na:na[typeof Symbol==='function'?Symbol.iterator:'@@iterator']();;){var qa;if(oa){if(pa>=na.length)break;qa=na[pa++];}else{pa=na.next();if(pa.done)break;qa=pa.value;}var ra=qa,sa=ia.mercury.tabContents.get(ra).messageStore;if(!sa){var ta=c('MercuryIDs').getThreadFBIDFromThreadID(ra);if(ma&&ma[ta]){ma[ta].threadID=ra;ia=z(ia,ma[ta]);}else ia=y(ia,ra);}}return ia;}else for(var ua=ia.tabGroup.tabs.keys(),va=Array.isArray(ua),wa=0,ua=va?ua:ua[typeof Symbol==='function'?Symbol.iterator:'@@iterator']();;){var xa;if(va){if(wa>=ua.length)break;xa=ua[wa++];}else{wa=ua.next();if(wa.done)break;xa=wa.value;}var ya=xa,za=c('MercuryIDs').getThreadFBIDFromThreadID(ya);if(ma&&ma[za]){ma[za].threadID=ya;ia=z(ia,ma[za]);}else ia=y(ia,ya);}break;}return ia;}function t(ia,ja){switch(ja.type){case k.FETCH_MORE_MESSAGES:var ka=ja.threadID,la=ia.mercury.tabContents.get(ka).messageStore;if(la&&!m[ka]){m[ka]=true;la.fetchMoreMessages();}break;}return ia;}function u(ia,ja,ka){i.getThreadMeta(ka,function(la){c('setImmediate')(function(){return c('FantaGetMessageActions').onGetThreadPreviewResponse(ja,la);});});return ia;}function v(ia,ja){switch(ja.type){case k.ON_GET_THREAD_PREVIEW_RESPONSE:var ka=ja.tabID,la=ja.thread;return w(ia,ka,la);}return ia;}function w(ia,ja,ka){var la=ka.thread_id,ma=new (c('MercuryMessageStore'))(la),na=ia.mercury.tabContents.get(ja);if(m[la]||!na)return ia;m[la]=true;na&&na.messageStore&&na.messageStore.destroy();ia=ia.mergeIn(['mercury','tabContents',ja],{thread:ka,messageStore:ma});var oa=setTimeout(function(){m[la]=false;c('FantaGetMessageActions').onShowContextBannerTimer(ja);},6000);ma.subscribe(function(pa){m[la]=false;var qa=pa.messages&&pa.messages[0];if(qa&&qa.log_message_type&&qa.log_message_type===c('MercuryLogMessageType').SERVER_ERROR&&na.messages.size===0){ma.fetchMoreMessages();}else{clearTimeout(oa);c('setImmediate')(function(){c('FantaGetMessageActions').onMessageStoreResponse(pa.messages,ja);});}});return ia;}function x(ia,ja){switch(ja.type){case k.REFRESH_THREAD:return y(ia,ja.threadID);}return ia;}function y(ia,ja){if(!l[ja]){var ka=c('getPageIDFromThreadID')(ja);if(ka){var la=c('XMNCommercePageNullStateCTAController').getURIBuilder();new (c('AsyncRequest'))().setURI(la.getURI()).setMethod('POST').setData({page_id:ka}).setHandler(function(ma){if(ma&&ma.payload){var na=ma.payload,oa=na.title,pa=na.id;c('FantaGetMessageActions').onPageNullResponse(ja,oa,pa);}}).send();}l[ja]=true;i.getThreadMeta(ja,function(ma){c('setImmediate')(function(){return c('FantaGetMessageActions').onGetThreadResponse(ma);});});}return ia;}function z(ia,ja){var ka=new (c('FantaTypeJoinableThread'))(ja),la=ja.threadID,ma=la&&ia.mercury.tabContents.get(la);if(ma)ia=ia.mergeIn(['mercury','tabContents',la],{joinableInterstitialData:ka});return ia;}function aa(ia,ja){switch(ja.type){case k.ON_PAGE_NULL_RESPONSE:var ka=ja.threadID,la=ja.nullPageTitle,ma=ja.nullPageID;if(ia.mercury.tabContents.get(ka))ia=ia.mergeIn(['mercury','tabContents',ka],{nullPageTitle:la,nullPageID:ma});break;}return ia;}function ba(ia,ja){switch(ja.type){case k.ON_GET_THREAD_RESPONSE:var ka=ja.thread;ia=ca(ia,ka);break;}return ia;}function ca(ia,ja){var ka=ja.thread_id;l[ka]=false;var la=ia.mercury.tabContents.get(ka);if(!la)return ia;var ma=la.messageStore;if(!ma){ia=w(ia,ka,ja);}else ia=ia.mergeIn(['mercury','tabContents',ka],{thread:ja});return ia;}function da(ia,ja){switch(ja.type){case k.THREADS_UPDATED:ja.threads.forEach(function(ka){ia=ca(ia,new (c('ImmutableObject'))(ka));});}return ia;}function ea(ia,ja){switch(ja.type){case k.ON_MESSAGE_STORE_RESPONSE:var ka=ja.messages,la=ja.tabID,ma=ia.mercury.tabContents.get(la),na=ma&&ma.messageStore;if(na){var oa=na.hasFetchedAll();ia=ia.mergeIn(['mercury','tabContents',la],{hasFetchedAll:oa,messages:c('immutable').List(ka)});}break;}return ia;}function fa(ia,ja){switch(ja.type){case k.ON_SHOW_CONTEXT_BANNER_TIMER:if(!ia.mercury.tabContents.get(ja.threadID))return ia;ia=ia.mergeIn(['mercury','tabContents',ja.threadID],{showContextBanner:true});break;}return ia;}function ga(ia,ja){switch(ja.type){case j.CLOSE_AND_TAB_NEXT:case j.FOCUS_NEXT_TAB:case j.FOCUS_PREVIOUS_TAB:case j.FOCUS_TAB:case j.SCROLL_BOTTOM_CHANGED:case j.UNMINIMIZE_TAB:case k.ON_GET_THREAD_RESPONSE:case k.ON_MESSAGE_STORE_RESPONSE:case k.REFRESH_THREAD:case k.THREADS_UPDATED:var ka=ia.tabGroup.focusedTabID;if(ka){var la=ia.tabGroup.tabs.get(ka);if(la&&!la.isMinimized&&c('UserActivity').isOnTab()&&c('UserActivity').isActive()){var ma=ia.mercury.tabContents.get(ka);if(ma&&ma.isScrolledToBottom)ha(ka);}}break;}return ia;}function ha(ia){h.markSeen(ia);h.markRead(ia);}f.exports={addParticipants:r,clearPreview:q,fetchMoreMessages:t,loadFromData:s,onFocusChange:ga,onGetThreadPreviewResponse:v,onGetThreadResponse:ba,onMessageStoreResponse:ea,onPageNullResponse:aa,onShowContextBannerTimer:fa,openInterstitialTab:o,openTab:n,refreshThread:x,replaceTab:p,threadsUpdated:da};}),null);
__d('FantaReducersSharePreview',['Bootloader','FantaMessageActions','FantaTabActions','FantaTypeSharePreview','immutable','ifRequired','setImmediate'],(function a(b,c,d,e,f,g){'use strict';var h=c('FantaMessageActions').Types,i=c('FantaTabActions').Types,j='scraperLastPermissiveMatch';function k(r,s){switch(s.type){case h.COMPOSER_TEXT_UPDATE:var t=s.message,u=s.threadID;r=l(r,t,u);}return r;}function l(r,s,t){c('ifRequired')('URLMatcher',function(u){c('ifRequired')('DataStore',function(v){if(s.length===0){v.remove(t,j);}else{if(!r.mercury.tabContents.get(t))return r;if(!u.trigger(s+' ')){var w=u.match(s),x=u.permissiveMatch(s);if(x&&x!==v.get(t,j)){v.set(t,j,x);r=r.mergeIn(['mercury','tabContents',t,'sharePreview'],{params:null,type:null,uri:w||x});}}}});},function(){c('Bootloader').loadModules(["URLMatcher","DataStore"],function(u,v){if(s.length>0)c('setImmediate')(function(){c('FantaMessageActions').composerTextUpdate(t,s);});},'FantaReducersSharePreview');});return r;}function m(r,s){switch(s.type){case h.LINK_PREVIEW:var t=s.uri,u=s.tabID;if(!r.mercury.tabContents.get(u))return r;r=r.mergeIn(['mercury','tabContents',u,'sharePreview'],{params:null,type:null,uri:t});}return r;}function n(r,s){switch(s.type){case h.LOADED_SHARE_DATA:var t=s.attachmentData,u=s.tabID,v=t.share_data;if(!r.mercury.tabContents.get(u))return r;r=r.mergeIn(['mercury','tabContents',u,'sharePreview'],{isLoading:false,params:c('immutable').Map({data:v.share_params}),type:v.share_type});}return r;}function o(r,s){switch(s.type){case h.LOADING_SHARE_DATA:var t=s.tabID;if(!r.mercury.tabContents.get(t))return r;r=r.mergeIn(['mercury','tabContents',t,'sharePreview'],{isLoading:true,params:null,type:null});}return r;}function p(r,s){switch(s.type){case i.CLOSE_ALL_TABS:var t=r.tabGroup.tabs.keys();for(var u=t,v=Array.isArray(u),w=0,u=v?u:u[typeof Symbol==='function'?Symbol.iterator:'@@iterator']();;){var x;if(v){if(w>=u.length)break;x=u[w++];}else{w=u.next();if(w.done)break;x=w.value;}var y=x;r=q(r,y);}break;case i.CLOSE_TAB:case i.CLOSE_AND_TAB_NEXT:case h.REMOVE_SHARE_PREVIEW:var z=s.tabID;r=q(r,z);}return r;}function q(r,s){if(!r.mercury.tabContents.get(s))return r;return r.setIn(['mercury','tabContents',s,'sharePreview'],new (c('FantaTypeSharePreview'))());}f.exports={closeTab:p,composerTextUpdate:k,linkPreview:m,loadedShareData:n,loadingShareData:o};}),null);